<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCash Payment - CodeMaster Academy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #007DFF 0%, #0066CC 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .gcash-container {
            background: white;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .gcash-header {
            background: linear-gradient(135deg, #007DFF 0%, #0066CC 100%);
            padding: 30px 20px;
            text-align: center;
            color: white;
        }

        .gcash-logo {
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .gcash-logo img {
            filter: brightness(0) invert(1);
        }

        .gcash-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .gcash-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .gcash-body {
            padding: 30px 20px;
        }

        .merchant-info {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .merchant-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .merchant-desc {
            font-size: 14px;
            color: #666;
        }

        .amount-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .amount-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .amount-value {
            font-size: 36px;
            font-weight: 700;
            color: #007DFF;
        }

        .payment-details {
            margin-bottom: 25px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-label {
            font-size: 14px;
            color: #666;
        }

        .detail-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .mobile-input-group {
            margin-bottom: 25px;
        }

        .mobile-label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .mobile-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .mobile-input:focus {
            outline: none;
            border-color: #007DFF;
            box-shadow: 0 0 0 3px rgba(0, 125, 255, 0.1);
        }

        .pay-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #007DFF 0%, #0066CC 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .pay-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 125, 255, 0.3);
        }

        .pay-button:active {
            transform: translateY(0);
        }

        .pay-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .cancel-button {
            width: 100%;
            padding: 16px;
            background: white;
            color: #666;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
        }

        .cancel-button:hover {
            background: #f8f9fa;
            border-color: #ccc;
        }

        .security-note {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .security-icon {
            color: #28a745;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .security-text {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-loading .btn-text {
            display: none;
        }

        .btn-loading .loading-spinner {
            display: block;
        }

        @media (max-width: 480px) {
            .gcash-container {
                border-radius: 0;
            }

            .amount-value {
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <div class="gcash-container">
        <div class="gcash-header">
            <div class="gcash-logo">
                <img src="assets/images/payment-logos/Gcash.png" alt="GCash" style="height: 80px; width: auto;">
            </div>
            <div class="gcash-title">GCash</div>
            <div class="gcash-subtitle">Secure Payment Gateway</div>
        </div>

        <div class="gcash-body">
            <div class="merchant-info">
                <div class="merchant-name">CodeMaster Academy</div>
                <div class="merchant-desc" id="courseTitle">Course Enrollment</div>
            </div>

            <div class="amount-section">
                <div class="amount-label">Amount to Pay</div>
                <div class="amount-value" id="paymentAmount">â‚±0.00</div>
            </div>

            <div class="payment-details">
                <div class="detail-row">
                    <span class="detail-label">Merchant</span>
                    <span class="detail-value">CodeMaster Academy</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Payment Method</span>
                    <span class="detail-value">GCash Wallet</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Transaction ID</span>
                    <span class="detail-value" id="transactionId">-</span>
                </div>
                <div class="detail-row" style="border-top: 1px solid #f0f0f0; margin-top: 10px; padding-top: 15px;">
                    <span class="detail-label"><i class="fas fa-clock"></i> Time Remaining</span>
                    <span class="detail-value" id="timer" style="color: #007DFF; font-weight: 600; font-size: 16px;">15:00</span>
                </div>
            </div>

            <div class="mobile-input-group">
                <label class="mobile-label" for="mobileNumber">
                    <i class="fas fa-mobile-alt"></i> GCash Mobile Number
                </label>
                <input 
                    type="tel" 
                    id="mobileNumber" 
                    class="mobile-input" 
                    placeholder="09XX XXX XXXX"
                    maxlength="11"
                    pattern="[0-9]{11}"
                >
            </div>

            <div class="mobile-input-group">
                <label class="mobile-label" for="mpin">
                    <i class="fas fa-lock"></i> 4-Digit MPIN
                </label>
                <input 
                    type="password" 
                    id="mpin" 
                    class="mobile-input" 
                    placeholder="Enter your 4-digit MPIN"
                    maxlength="4"
                    pattern="[0-9]{4}"
                    inputmode="numeric"
                >
            </div>

            <button class="pay-button" id="payButton">
                <span class="btn-text">
                    <i class="fas fa-lock"></i> Pay with GCash
                </span>
                <span class="loading-spinner"></span>
            </button>

            <button class="cancel-button" id="cancelButton">
                Cancel Payment
            </button>

            <div class="security-note">
                <div class="security-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="security-text">
                    Your payment is secured with 256-bit SSL encryption.<br>
                    Powered by Xendit Payment Gateway.
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/supabase-config.js"></script>
    <script src="assets/js/wallet-manager.js"></script>
    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('course');
        const amount = urlParams.get('amount');
        const courseName = urlParams.get('name');
        const referenceId = urlParams.get('ref');

        // Display payment info
        if (amount) {
            document.getElementById('paymentAmount').textContent = `â‚±${parseFloat(amount).toLocaleString()}`;
        }

        if (courseName) {
            document.getElementById('courseTitle').textContent = decodeURIComponent(courseName);
        }

        if (referenceId) {
            document.getElementById('transactionId').textContent = referenceId;
        } else {
            document.getElementById('transactionId').textContent = `GCASH${Date.now()}`;
        }

        // Mobile number formatting
        const mobileInput = document.getElementById('mobileNumber');
        mobileInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) {
                value = value.slice(0, 11);
            }
            e.target.value = value;
        });

        // MPIN input formatting
        const mpinInput = document.getElementById('mpin');
        mpinInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) {
                value = value.slice(0, 4);
            }
            e.target.value = value;
        });

        // Pay button handler
        const payButton = document.getElementById('payButton');
        payButton.addEventListener('click', async function() {
            const mobileNumber = mobileInput.value.trim();
            const mpin = mpinInput.value.trim();

            // Validate mobile number
            if (!mobileNumber || mobileNumber.length !== 11) {
                alert('Please enter a valid 11-digit mobile number');
                mobileInput.focus();
                return;
            }

            if (!mobileNumber.startsWith('09')) {
                alert('Mobile number must start with 09');
                mobileInput.focus();
                return;
            }

            // Validate MPIN
            if (!mpin || mpin.length !== 4) {
                alert('Please enter your 4-digit MPIN');
                mpinInput.focus();
                return;
            }

            // Show loading state
            payButton.classList.add('btn-loading');
            payButton.disabled = true;

            try {
                // Save wallet credentials to database
                console.log('ðŸ’¾ Saving GCash wallet...');
                const saveResult = await window.walletManager.saveGCashWallet(mobileNumber, mpin);
                
                if (!saveResult.success) {
                    throw new Error(saveResult.error);
                }
                console.log('âœ… Wallet saved:', saveResult.message);

                // Record transaction in database
                console.log('ðŸ“ Recording transaction...');
                const transactionResult = await window.walletManager.recordTransaction(
                    'gcash',
                    mobileNumber,
                    parseFloat(amount),
                    parseInt(courseId),
                    decodeURIComponent(courseName || 'Course')
                );

                if (!transactionResult.success) {
                    throw new Error(transactionResult.error);
                }
                console.log('âœ… Transaction recorded:', transactionResult.reference);

                // Store transaction reference
                sessionStorage.setItem('transactionRef', transactionResult.reference);

                // Simulate payment processing
                setTimeout(async () => {
                    // Update transaction status to success
                    await window.walletManager.updateTransactionStatus(
                        transactionResult.reference,
                        'success'
                    );
                    console.log('âœ… Transaction marked as successful');

                    // Store payment info for enrollment
                    const paymentInfo = {
                        paymentId: transactionResult.reference,
                        paymentMethod: 'gcash',
                        courseId: parseInt(courseId),
                        courseName: decodeURIComponent(courseName || 'Course'),
                        amount: parseFloat(amount)
                    };
                    sessionStorage.setItem('pendingPayment', JSON.stringify(paymentInfo));

                    // Redirect to success page
                    const successUrl = `payment-success.html?course=${courseId}&method=gcash&amount=${amount}&ref=${transactionResult.reference}`;
                    window.location.href = successUrl;
                }, 2000);

            } catch (error) {
                console.error('âŒ Payment error:', error);
                alert('Payment failed: ' + error.message);
                
                // Reset button state
                payButton.classList.remove('btn-loading');
                payButton.disabled = false;
            }
        });

        // Cancel button handler
        const cancelButton = document.getElementById('cancelButton');
        cancelButton.addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel this payment?')) {
                const failureUrl = `payment-failed.html?course=${courseId}&method=gcash`;
                window.location.href = failureUrl;
            }
        });

        // Auto-focus mobile input
        window.addEventListener('load', () => {
            mobileInput.focus();
        });

        // 15-minute countdown timer
        let timeRemaining = 15 * 60; // 15 minutes in seconds
        const timerElement = document.getElementById('timer');

        function updateTimer() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            
            // Format as MM:SS
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color when time is running out
            if (timeRemaining <= 60) {
                timerElement.style.color = '#dc3545'; // Red
            } else if (timeRemaining <= 300) {
                timerElement.style.color = '#ffc107'; // Yellow/Orange
            }
            
            // Countdown
            if (timeRemaining > 0) {
                timeRemaining--;
            } else {
                // Time expired
                clearInterval(timerInterval);
                alert('Payment session has expired. You will be redirected to the failure page.');
                window.location.href = `payment-failed.html?course=${courseId}&method=gcash&reason=timeout`;
            }
        }

        // Update timer every second
        const timerInterval = setInterval(updateTimer, 1000);
        
        // Initial update
        updateTimer();
    </script>
</body>
</html>
